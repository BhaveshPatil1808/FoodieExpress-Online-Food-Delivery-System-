<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Payment Gateway | FoodieExpress</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Mimicking Razorpay's primary color contrast */
            --theme-primary: #3476f5; /* A strong blue */
            --theme-accent: #00bcd4; /* Cyan for hover/focus */
            --theme-success: #4CAF50;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb; /* Light, neutral background */
        }
        .text-theme { color: var(--theme-primary); }
        .bg-theme { background-color: var(--theme-primary); }
        .border-theme { border-color: var(--theme-primary); }

        /* Custom Input Styling */
        .custom-input {
            border: 1px solid #e0e6ed;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        .custom-input:focus {
            border-color: var(--theme-primary);
            box-shadow: 0 0 0 1px var(--theme-primary);
            outline: none;
        }
        
        /* Tab/Method Selector Style */
        .method-tab {
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            padding: 0.75rem 0;
            color: #6b7280;
        }
        .method-tab.active {
            color: var(--theme-primary);
            border-bottom-color: var(--theme-primary);
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Shared Modal Backdrop */
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(3px);
            z-index: 50;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

<!-- Main Payment Interface Container -->
<div class="w-full max-w-2xl bg-white rounded-xl shadow-2xl overflow-hidden flex flex-col lg:flex-row">

    <!-- LEFT SIDE: Branding and Summary -->
    <div class="lg:w-1/3 bg-gray-50 p-6 flex flex-col justify-between border-b lg:border-r lg:border-b-0 border-gray-100">
        <div>
            <div class="flex items-center space-x-2 mb-8">
                <i class="fas fa-bolt text-3xl text-theme"></i>
                <span class="text-xl font-extrabold text-gray-800">QuickPay</span>
            </div>
            
            <h3 class="text-gray-500 font-medium text-sm uppercase tracking-wider mb-2">You are paying</h3>
            <div class="text-3xl font-bold text-gray-800 mb-6">
                <!-- THYMELEAF: Dynamically set payment amount -->
                ₹<span id="paymentAmount" th:text="${amount}">1250.00</span>
            </div>

            <h3 class="text-gray-500 font-medium text-sm uppercase tracking-wider mb-2">Payment For</h3>
            <p class="text-gray-700 font-semibold mb-4">
                <!-- THYMELEAF: Dynamically set Order ID -->
                FoodieExpress Order #<span th:text="${orderId}">FE10938</span>
            </p>

            <p class="text-xs text-gray-400 mt-4">
                <i class="fas fa-lock text-theme mr-1"></i> 100% Secure Transaction.
            </p>
        </div>
        
        <div class="mt-8">
            <p class="text-xs text-gray-400">Accepted Cards</p>
            <div class="flex space-x-2 mt-1 text-2xl text-gray-500">
                <i class="fab fa-cc-visa"></i>
                <i class="fab fa-cc-mastercard"></i>
                <i class="fab fa-cc-amex"></i>
                <i class="fas fa-credit-card"></i>
            </div>
        </div>
    </div>

    <!-- RIGHT SIDE: Payment Methods and Form -->
    <div class="lg:w-2/3 p-6 md:p-8">
        <h2 class="text-xl font-bold text-gray-800 mb-6">Select a Payment Method</h2>

        <!-- Method Tabs -->
        <div class="flex border-b border-gray-200 mb-6 space-x-4">
            <div class="method-tab active" data-method="card">
                <i class="fas fa-credit-card mr-2"></i> Cards
            </div>
            <div class="method-tab opacity-50 cursor-default" data-method="upi">
                <i class="fas fa-qrcode mr-2"></i> UPI (Disabled)
            </div>
            <div class="method-tab opacity-50 cursor-default" data-method="netbanking">
                <i class="fas fa-university mr-2"></i> Net Banking (Disabled)
            </div>
        </div>
        
        <!-- Payment Content (Card Form) -->
        <div id="cardContent" class="payment-content space-y-4">
            <form id="paymentForm" onsubmit="processCard(event)">
                
                <!-- Card Number -->
                <div>
                    <label for="cardNumber" class="block text-sm font-medium text-gray-700 mb-1">Card Number</label>
                    <input type="text" id="cardNumber" maxlength="19" inputmode="numeric" placeholder="XXXX XXXX XXXX XXXX" 
                           class="custom-input w-full p-3 rounded-lg text-lg" required>
                    <p id="cardError" class="text-xs text-red-500 mt-1 hidden">Please enter a valid 16-digit card number.</p>
                </div>

                <!-- Card Holder Name -->
                <div>
                    <label for="cardName" class="block text-sm font-medium text-gray-700 mb-1">Name on Card</label>
                    <input type="text" id="cardName" placeholder="Name as on card" 
                           class="custom-input w-full p-3 rounded-lg text-lg" required>
                </div>

                <!-- Expiry and CVV -->
                <div class="flex space-x-4">
                    <div class="w-1/2">
                        <label for="expiry" class="block text-sm font-medium text-gray-700 mb-1">Valid Till (MM/YY)</label>
                        <input type="text" id="expiry" maxlength="5" inputmode="numeric" placeholder="MM/YY" 
                               class="custom-input w-full p-3 rounded-lg text-lg" required>
                    </div>
                    <div class="w-1/2">
                        <label for="cvv" class="block text-sm font-medium text-gray-700 mb-1">CVV</label>
                        <input type="password" id="cvv" maxlength="3" inputmode="numeric" placeholder="***" 
                               class="custom-input w-full p-3 rounded-lg text-lg" required>
                    </div>
                </div>
                
                <!-- Pay Button (Card Form Submission) -->
                <button type="submit" id="cardPayButton" 
                        class="bg-theme text-white font-bold w-full py-3 rounded-lg hover:bg-opacity-90 transition duration-200 flex items-center justify-center space-x-3 mt-6">
                    <!-- THYMELEAF: Dynamically set button text -->
                    <span id="cardButtonText">Pay ₹<span th:text="${amount}">1250.00</span></span>
                    <div class="spinner" id="cardLoadingSpinner"></div>
                </button>

            </form>
        </div>
    </div>
</div>

<!-- 1. Simulated OTP/3D Secure Modal -->
<div id="otpModal" class="modal-backdrop">
    <div class="bg-white p-8 rounded-xl w-11/12 max-w-md text-center shadow-2xl transform scale-95 transition-transform duration-300" 
         id="otpModalContent">
        
        <i class="fas fa-lock text-5xl text-theme mb-4"></i>
        <h3 class="text-xl font-bold text-gray-800 mb-2">Simulated Bank OTP Page</h3>
        <p class="text-gray-600 mb-6">Enter the One-Time Password sent to your registered mobile number.</p>

        <form id="otpForm" onsubmit="processOTP(event)" class="space-y-4">
            <div class="flex justify-center">
                 <input type="text" id="otpInput" maxlength="4" inputmode="numeric" placeholder="XXXX" required
                       class="custom-input text-center text-3xl font-mono tracking-widest p-4 rounded-lg w-32 border-2">
            </div>
            <p class="text-xs text-gray-500">Hint: Use any 4 digits except **1234** for success.</p>
            <p id="otpError" class="text-sm text-red-500 mt-1 hidden">Incorrect OTP. Please try again.</p>

            <button type="submit" id="otpButton" 
                    class="bg-theme text-white font-bold w-full py-3 rounded-lg hover:bg-opacity-90 transition duration-200 flex items-center justify-center space-x-3">
                <span id="otpButtonText">Verify & Pay</span>
                <div class="spinner" id="otpLoadingSpinner"></div>
            </button>
        </form>
        <button onclick="closeOTPModal(true)" class="text-sm text-red-500 mt-4 hover:text-red-700 transition">Cancel Transaction</button>
    </div>
</div>


<!-- 2. Final Result Modal -->
<div id="finalResultModal" class="modal-backdrop">
    <div class="bg-white p-8 rounded-xl w-11/12 max-w-sm text-center shadow-2xl transform scale-95 transition-transform duration-300" 
         id="resultModalContent">
        
        <i id="modalIcon" class="text-6xl mb-4"></i>
        <h3 id="modalTitle" class="text-2xl font-bold mb-2"></h3>
        <p id="modalMessage" class="text-gray-600 mb-6"></p>

        <button onclick="closeResultModal()" 
                class="w-full py-3 rounded-lg text-white font-semibold transition duration-200"
                id="modalButton">
            Go to Order History
        </button>
    </div>
</div>

<script>
    // --- Global State ---
    let lastTransactionSuccess = false; 

    // --- DOM Elements ---
    const form = document.getElementById('paymentForm');
    const cardPayButton = document.getElementById('cardPayButton');
    const cardButtonText = document.getElementById('cardButtonText');
    const cardLoadingSpinner = document.getElementById('cardLoadingSpinner');
    const cardError = document.getElementById('cardError');

    const otpModal = document.getElementById('otpModal');
    const otpForm = document.getElementById('otpForm');
    const otpInput = document.getElementById('otpInput');
    const otpButton = document.getElementById('otpButton');
    const otpButtonText = document.getElementById('otpButtonText');
    const otpLoadingSpinner = document.getElementById('otpLoadingSpinner');
    const otpError = document.getElementById('otpError');
    const otpModalContent = document.getElementById('otpModalContent');

    const finalResultModal = document.getElementById('finalResultModal');
    const resultModalContent = document.getElementById('resultModalContent');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const modalIcon = document.getElementById('modalIcon');
    const modalButton = document.getElementById('modalButton');
    
    // Dynamically retrieve the payment amount inserted by the templating engine
    // This script reads the value rendered by Thymeleaf into the #paymentAmount span.
    const amountElement = document.getElementById('paymentAmount');
    const rawPaymentAmount = amountElement ? amountElement.textContent.trim() : '1250.00';
    // Remove currency symbols/non-numeric characters for clean use in JS
    const paymentAmount = rawPaymentAmount.replace(/[^0-9.]/g, ''); 
    

    // --- Utility Functions ---

    function varToHex(cssVar) {
        return getComputedStyle(document.documentElement).getPropertyValue(cssVar).trim();
    }

    function formatCardNumber(e) {
        let value = e.target.value.replace(/\s/g, '');
        // Insert space every 4 digits, ensuring max length is respected (16 digits + 3 spaces = 19 max length)
        e.target.value = value.replace(/(\d{4})/g, '$1 ').trim();
    }

    function formatExpiryDate(e) {
        let input = e.target;
        let value = input.value.replace(/\D/g, ''); 

        if (value.length > 2) {
            value = value.substring(0, 2) + '/' + value.substring(2, 4);
        }
        input.value = value;
    }

    // Attach formatters
    document.getElementById('cardNumber').addEventListener('input', formatCardNumber);
    document.getElementById('expiry').addEventListener('input', formatExpiryDate);
    
    // --- Form State Management ---

    function setCardFormDisabled(disabled) {
        cardPayButton.disabled = disabled;
        if (disabled) {
            cardPayButton.classList.add('opacity-50', 'cursor-not-allowed');
            cardButtonText.textContent = "Processing Card..."; // Use textContent to avoid re-inserting th:text tags
            cardLoadingSpinner.style.display = 'block';
        } else {
            cardPayButton.classList.remove('opacity-50', 'cursor-not-allowed');
            // Reconstruct text using the clean amount read from the dynamically rendered span
            cardButtonText.textContent = `Pay ₹${paymentAmount}`; 
            cardLoadingSpinner.style.display = 'none';
        }
        Array.from(form.elements).forEach(el => el.disabled = disabled);
    }
    
    function setOTPFormDisabled(disabled) {
        otpButton.disabled = disabled;
        if (disabled) {
            otpButton.classList.add('opacity-50', 'cursor-not-allowed');
            otpButtonText.textContent = "Verifying...";
            otpLoadingSpinner.style.display = 'block';
        } else {
            otpButton.classList.remove('opacity-50', 'cursor-not-allowed');
            otpButtonText.textContent = "Verify & Pay";
            otpLoadingSpinner.style.display = 'none';
        }
        otpInput.disabled = disabled;
    }


    // --- Card Payment Step (Step 1) ---

    function validateCardForm() {
        let valid = true;
        const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
        
        // 1. Check card number length
        if (cardNumber.length !== 16) {
            cardError.classList.remove('hidden');
            valid = false;
        } else {
            cardError.classList.add('hidden');
        }

        // 2. Simple check for required fields
        Array.from(form.querySelectorAll('[required]')).forEach(input => {
            if (!input.value.trim() || (input.type === 'password' && input.value.length !== 3) ) {
                input.classList.add('border-red-500');
                valid = false;
            } else {
                input.classList.remove('border-red-500');
            }
        });

        return valid;
    }

    function processCard(event) {
        event.preventDefault();

        if (!validateCardForm()) {
            return;
        }
        
        setCardFormDisabled(true);

        // Simulate secure card processing delay
        setTimeout(() => {
            // In a real app, this would be an API call that returns a redirect/OTP challenge
            showOTPModal(); 
        }, 1500); 
    }


    // --- OTP Verification Step (Step 2) ---

    function showOTPModal() {
        otpModal.style.display = 'flex';
        otpInput.value = ''; // Clear OTP field
        otpError.classList.add('hidden');
        setOTPFormDisabled(false);
        // Simple animation
        setTimeout(() => otpModalContent.style.transform = 'scale(1)', 10);
    }

    function closeOTPModal(isCancel = false) {
        if (isCancel) {
            // If user cancels, we treat it as a failure and show result modal
            showResultModal(false, "Transaction Cancelled", "You cancelled the transaction at the bank verification step.");
        }
        otpModalContent.style.transform = 'scale(0.95)';
        setTimeout(() => {
            otpModal.style.display = 'none';
            // Only re-enable card form if transaction wasn't cancelled (it gets enabled later in closeResultModal)
            if (!isCancel) { 
                setCardFormDisabled(false); 
            }
        }, 300);
    }

    function processOTP(event) {
        event.preventDefault();

        const otp = otpInput.value.trim();
        if (otp.length !== 4) {
            otpError.textContent = "Please enter the 4-digit OTP.";
            otpError.classList.remove('hidden');
            return;
        }
        otpError.classList.add('hidden');
        setOTPFormDisabled(true);

        // SIMULATE OTP VALIDATION LOGIC
        const isSuccessful = otp !== '1234'; // '1234' is the failure code

        // Simulate network delay (2 seconds) for bank validation
        setTimeout(() => {
	    if (isSuccessful) {
	        closeOTPModal();
	        // ✅ Trigger backend order placement
	        window.location.href = "/customer/place-order";
	    } else {
	        otpError.textContent = "The OTP entered is incorrect. Please check and try again.";
	        otpError.classList.remove('hidden');
	        setOTPFormDisabled(false);
	    }
	}, 2000); 
    }


    // --- Final Result Step (Step 3) ---

    function showResultModal(success, title, message) {
        // Set global state
        lastTransactionSuccess = success; 

        // Hide OTP modal if it's visible
        otpModal.style.display = 'none';
        
        modalTitle.textContent = title;
        modalMessage.textContent = message;

        if (success) {
            modalIcon.className = "fas fa-check-circle";
            modalIcon.style.color = varToHex('--theme-success');
            modalButton.style.backgroundColor = varToHex('--theme-success');
            modalButton.style.boxShadow = "0 4px 10px rgba(76, 175, 80, 0.4)";
            modalButton.textContent = "View Order Status";
        } else {
            modalIcon.className = "fas fa-times-circle";
            modalIcon.style.color = '#ef4444';
            modalButton.style.backgroundColor = '#ef4444';
            modalButton.style.boxShadow = "0 4px 10px rgba(239, 68, 68, 0.4)";
            modalButton.textContent = "Try Payment Again";
        }
        
        finalResultModal.style.display = 'flex';
        // Simple animation
        setTimeout(() => resultModalContent.style.transform = 'scale(1)', 10);
    }

    function closeResultModal() {
        resultModalContent.style.transform = 'scale(0.95)';
        setTimeout(() => finalResultModal.style.display = 'none', 300);
        
        // REDIRECTION LOGIC
        if (lastTransactionSuccess) {
            // Redirect to the order history/status page on success
            window.location.href = "/customer/orders";
        } else {
            // Reset form for next attempt on failure
            form.reset();
            otpForm.reset();
            // Reset card button text with the dynamic amount
            setCardFormDisabled(false); 
        }
    }
</script>
</body>
</html>
